<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイムライン</title>
    <style>
        body { font-family: sans-serif; background-color: #e8eaf6; padding: 20px; }
        .post-list { max-width: 600px; margin: 0 auto; }
        .post-card { background: white; border: 1px solid #c5cae9; border-radius: 8px; padding: 15px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .post-username { font-weight: bold; color: #3f51b5; }
        .post-date { font-size: 0.8em; color: #757575; }
        .post-content { margin-bottom: 15px; line-height: 1.6; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .post-actions { display: flex; gap: 20px; margin-bottom: 15px; }
        .like-button { background: none; border: none; cursor: pointer; color: #3f51b5; font-weight: bold; }
        .like-button:hover { color: #ff6347; }
        
        /* コメントフォームのスタイル */
        .comment-form input[type="text"] { width: calc(100% - 70px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        .comment-form button { padding: 8px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .comment-form button:hover { background-color: #4cae4c; }
        #message { text-align: center; margin-bottom: 15px; font-weight: bold; }
        .logout-link { float: right; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="logout-link">
        <a href="#" id="logoutButton">ログアウト</a>
        | <a href="/post.html">新規投稿</a>
    </div>
    <h1>タイムライン</h1>
    <div id="message"></div>
    <div class="post-list" id="postList">
        <p>投稿を読み込み中...</p>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const postListDiv = document.getElementById('postList');
        const messageDiv = document.getElementById('message');

        // ログインしていない場合は強制的にログイン画面へ
        if (!token) {
            messageDiv.textContent = 'ログインしてください。';
            messageDiv.style.color = 'red';
            setTimeout(() => { window.location.href = '/login.html'; }, 1500);
        }

        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // ----------------------------------------------------
        // いいね処理
        // ----------------------------------------------------
        async function handleLike(postId, buttonElement) {
            if (!token) return alert('いいねするにはログインが必要です。');
            
            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'PUT',
                    headers: { 'x-auth-token': token }
                });

                if (response.ok) {
                    const updatedPost = await response.json();
                    // ボタンのテキストを更新後のいいね数で更新
                    buttonElement.textContent = `いいね (${updatedPost.likes})`;
                } else if (response.status === 401) {
                    alert('認証期限が切れました。再ログインしてください。');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                } else {
                    alert('いいね処理に失敗しました。');
                }
            } catch (error) {
                console.error('いいね通信エラー:', error);
                alert('サーバーとの通信に失敗しました。');
            }
        }

        // ----------------------------------------------------
        // コメント投稿処理
        // ----------------------------------------------------
        async function handleCommentSubmit(event, postId) {
            event.preventDefault();
            if (!token) return alert('コメントするにはログインが必要です。');

            const form = event.target;
            const content = form.querySelector('input[name="content"]').value;

            try {
                const response = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-auth-token': token 
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    messageDiv.textContent = 'コメントが投稿されました！';
                    messageDiv.style.color = 'green';
                    form.reset(); // フォームをクリア
                    // 🚨 ここでコメントを再読み込みする機能を追加するのが理想ですが、今回は成功メッセージのみとします。
                } else {
                    const result = await response.json();
                    alert('コメント投稿失敗: ' + (result.msg || '認証またはサーバーエラー'));
                }

            } catch (error) {
                console.error('コメント通信エラー:', error);
                alert('サーバーとの通信に失敗しました。');
            }
        }


        // ----------------------------------------------------
        // 投稿表示（メインの描画ロジック）
        // ----------------------------------------------------
        async function fetchPosts() {
            postListDiv.innerHTML = '<p>投稿を読み込み中...</p>';

            try {
                const response = await fetch('/api/posts'); 
                const posts = await response.json(); 

                if (response.ok) {
                    postListDiv.innerHTML = '';
                    if (posts.length === 0) {
                        postListDiv.innerHTML = '<p>まだ投稿がありません。</p>';
                        return;
                    }

                    posts.forEach(post => {
                        const postCard = document.createElement('div');
                        postCard.className = 'post-card';

                        const date = new Date(post.createdAt).toLocaleDateString();

                        postCard.innerHTML = `
                            <div class="post-header">
                                <span class="post-username">@${post.author.username}</span>
                                <span class="post-date">${date}</span>
                            </div>
                            <p class="post-content">${post.content}</p>
                            <div class="post-actions">
                                <button class="like-button" data-post-id="${post._id}">いいね (${post.likes})</button>
                                <span>コメント (0)</span> 
                            </div>
                            
                            <form class="comment-form" data-post-id="${post._id}">
                                <input type="text" name="content" placeholder="コメントを入力..." required maxlength="140">
                                <button type="submit">投稿</button>
                            </form>
                        `;
                        postListDiv.appendChild(postCard);

                        // 🚨 イベントリスナーの設定:
                        // 生成されたボタンとフォームにアクションを設定します
                        const likeButton = postCard.querySelector('.like-button');
                        likeButton.addEventListener('click', () => handleLike(post._id, likeButton));

                        const commentForm = postCard.querySelector('.comment-form');
                        commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, post._id));
                    });

                } else {
                    messageDiv.innerHTML = `<p style="color: red;">投稿の取得に失敗しました: ${posts.msg || 'サーバーエラー'}</p>`;
                }

            } catch (error) {
                console.error('通信エラー:', error);
                postListDiv.innerHTML = '<p style="color: red;">エラー: サーバーに接続できませんでした。</p>';
            }
        }

        fetchPosts();
    </script>
</body>
</html>