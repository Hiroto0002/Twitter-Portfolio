<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</title>
    <style>
        body { font-family: sans-serif; background-color: #e8eaf6; padding: 20px; }
        .post-list { max-width: 600px; margin: 0 auto; }
        .post-card { background: white; border: 1px solid #c5cae9; border-radius: 8px; padding: 15px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .post-username { font-weight: bold; color: #3f51b5; }
        .post-date { font-size: 0.8em; color: #757575; }
        .post-content { margin-bottom: 15px; line-height: 1.6; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .post-actions { display: flex; gap: 20px; margin-bottom: 15px; }
        .like-button { background: none; border: none; cursor: pointer; color: #3f51b5; font-weight: bold; }
        .like-button:hover { color: #ff6347; }
        
        /* ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .comment-form input[type="text"] { width: calc(100% - 70px); padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; }
        .comment-form button { padding: 8px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .comment-form button:hover { background-color: #4cae4c; }
        #message { text-align: center; margin-bottom: 15px; font-weight: bold; }
        .logout-link { float: right; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="logout-link">
        <a href="#" id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        | <a href="/post.html">æ–°è¦æŠ•ç¨¿</a>
    </div>
    <h1>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h1>
    <div id="message"></div>
    <div class="post-list" id="postList">
        <p>æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const postListDiv = document.getElementById('postList');
        const messageDiv = document.getElementById('message');

        // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯å¼·åˆ¶çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
        if (!token) {
            messageDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
            messageDiv.style.color = 'red';
            setTimeout(() => { window.location.href = '/login.html'; }, 1500);
        }

        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // ----------------------------------------------------
        // ã„ã„ã­å‡¦ç†
        // ----------------------------------------------------
        async function handleLike(postId, buttonElement) {
            if (!token) return alert('ã„ã„ã­ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
            
            try {
                const response = await fetch(`/api/posts/${postId}/like`, {
                    method: 'PUT',
                    headers: { 'x-auth-token': token }
                });

                if (response.ok) {
                    const updatedPost = await response.json();
                    // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°å¾Œã®ã„ã„ã­æ•°ã§æ›´æ–°
                    buttonElement.textContent = `ã„ã„ã­ (${updatedPost.likes})`;
                } else if (response.status === 401) {
                    alert('èªè¨¼æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                } else {
                    alert('ã„ã„ã­å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('ã„ã„ã­é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ----------------------------------------------------
        // ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å‡¦ç†
        // ----------------------------------------------------
        async function handleCommentSubmit(event, postId) {
            event.preventDefault();
            if (!token) return alert('ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');

            const form = event.target;
            const content = form.querySelector('input[name="content"]').value;

            try {
                const response = await fetch(`/api/posts/${postId}/comments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-auth-token': token 
                    },
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    messageDiv.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼';
                    messageDiv.style.color = 'green';
                    form.reset(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                    // ğŸš¨ ã“ã“ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã®ãŒç†æƒ³ã§ã™ãŒã€ä»Šå›ã¯æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã¨ã—ã¾ã™ã€‚
                } else {
                    const result = await response.json();
                    alert('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿å¤±æ•—: ' + (result.msg || 'èªè¨¼ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'));
                }

            } catch (error) {
                console.error('ã‚³ãƒ¡ãƒ³ãƒˆé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }


        // ----------------------------------------------------
        // æŠ•ç¨¿è¡¨ç¤ºï¼ˆãƒ¡ã‚¤ãƒ³ã®æç”»ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        // ----------------------------------------------------
        async function fetchPosts() {
            postListDiv.innerHTML = '<p>æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

            try {
                const response = await fetch('/api/posts'); 
                const posts = await response.json(); 

                if (response.ok) {
                    postListDiv.innerHTML = '';
                    if (posts.length === 0) {
                        postListDiv.innerHTML = '<p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                        return;
                    }

                    posts.forEach(post => {
                        const postCard = document.createElement('div');
                        postCard.className = 'post-card';

                        const date = new Date(post.createdAt).toLocaleDateString();

                        postCard.innerHTML = `
                            <div class="post-header">
                                <span class="post-username">@${post.author.username}</span>
                                <span class="post-date">${date}</span>
                            </div>
                            <p class="post-content">${post.content}</p>
                            <div class="post-actions">
                                <button class="like-button" data-post-id="${post._id}">ã„ã„ã­ (${post.likes})</button>
                                <span>ã‚³ãƒ¡ãƒ³ãƒˆ (0)</span> 
                            </div>
                            
                            <form class="comment-form" data-post-id="${post._id}">
                                <input type="text" name="content" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." required maxlength="140">
                                <button type="submit">æŠ•ç¨¿</button>
                            </form>
                        `;
                        postListDiv.appendChild(postCard);

                        // ğŸš¨ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š:
                        // ç”Ÿæˆã•ã‚ŒãŸãƒœã‚¿ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¾ã™
                        const likeButton = postCard.querySelector('.like-button');
                        likeButton.addEventListener('click', () => handleLike(post._id, likeButton));

                        const commentForm = postCard.querySelector('.comment-form');
                        commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, post._id));
                    });

                } else {
                    messageDiv.innerHTML = `<p style="color: red;">æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${posts.msg || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼'}</p>`;
                }

            } catch (error) {
                console.error('é€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                postListDiv.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            }
        }

        fetchPosts();
    </script>
</body>
</html>