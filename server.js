// .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿ã¾ã™
require('dotenv').config();

// Expressã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«èª­ã¿è¾¼ã¿ã¾ã™
const express = require('express');

// Node.jsã®æ¨™æº–æ©Ÿèƒ½ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ‰±ã†ãŸã‚ã®'path'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
const path = require('path'); 

// Mongooseã‚’èª­ã¿è¾¼ã¿ã¾ã™
const mongoose = require('mongoose');

// Expressã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚¢ãƒ—ãƒªï¼‰ã‚’ä½œã‚Šã¾ã™
const app = express();

// ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã‚’æ±ºã‚ã¾ã™
const PORT = 3000;

// **********************************************
// **** ã“ã“ã‹ã‚‰æ–°ã—ãè¿½åŠ ãƒ»ä¿®æ­£ã™ã‚‹éƒ¨åˆ†ã§ã™ ****
// **********************************************

// **********************************************
// **** ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å—ã‘å–ã‚Šè¨­å®šã‚’è¿½åŠ  (New!) ****
// **********************************************

// ãƒ•ã‚©ãƒ¼ãƒ ã§é€ä¿¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è§£æã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
app.use(express.urlencoded({ extended: true }));
// JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚‚å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™
app.use(express.json());

// **********************************************
// **********************************************



// MongoDB Atlasã‹ã‚‰å–å¾—ã—ãŸæ¥ç¶šURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¾ã™
// ğŸš¨ <username>ã¨<password>ã€<dbname>ã‚’ã€ã‚ãªãŸãŒè¨­å®šã—ãŸå€¤ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼
const DB_URL = 'mongodb+srv://Hiro:1tOkU1jt2YyaldzN@cluster0.pkspjnj.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0';
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
mongoose.connect(DB_URL)
    .then(() => {
        console.log('âœ… MongoDBã¸ã®æ¥ç¶šã«æˆåŠŸã—ã¾ã—ãŸï¼');
    })
    .catch(err => {
        console.error('âŒ MongoDBæ¥ç¶šã‚¨ãƒ©ãƒ¼:', err);
    });

// **********************************************
// **********************************************

// é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ä¿¡ã™ã‚‹ãŸã‚ã®è¨­å®š
// app.use() ã¯ã€Œã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã“ã‚Œã‚’ä½¿ã£ã¦ã­ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚
// express.static() ã¯ã€æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«å…¬é–‹ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚
app.use(express.static(path.join(__dirname, 'public')));

// ä»¥å‰ã®ã€ŒHello World!ã€ã®è¨­å®šã¯å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚
/*
app.get('/', (req, res) => {
  res.send('Hello World! ã“ã‚ŒãŒç§ã®ä½œã£ãŸæœ€åˆã®ã‚µãƒ¼ãƒãƒ¼ã§ã™ï¼');
});
*/

// **********************************************
// **********************************************

// ã‚µãƒ¼ãƒãƒ¼ã‚’æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆç•ªå·ã§èµ·å‹•ã—ã¾ã™
app.listen(PORT, () => {
  console.log(`ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://localhost:${PORT}`);
  console.log('ãƒ–ãƒ©ã‚¦ã‚¶ã§ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
});

// é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ä¿¡ã™ã‚‹ãŸã‚ã®è¨­å®š (å¤‰æ›´ãªã—)
app.use(express.static(path.join(__dirname, 'public')));

// ã‚µãƒ¼ãƒãƒ¼ã‚’æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆç•ªå·ã§èµ·å‹•ã—ã¾ã™ (å¤‰æ›´ãªã—)
app.listen(PORT, () => {
  console.log(`ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://localhost:${PORT}`);
});

// **********************************************
// ****   ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®šç¾©   ****
// **********************************************

// ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
const User = require('./models/User');
// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æš—å·åŒ–ãƒ„ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
const bcrypt = require('bcryptjs');

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™»éŒ²æƒ…å ±ã‚’ POST ã§é€ä¿¡ã™ã‚‹ã¨ã€ã“ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
app.post('/register', async (req, res) => {
    try {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ã‚‰ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’å—ã‘å–ã‚Šã¾ã™
        const { username, password } = req.body;

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
        const existingUser = await User.findOne({ username });
        if (existingUser) {
            return res.status(400).send('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚');
        }

        // 2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æš—å·åŒ–
        // 10ã¯æš—å·åŒ–ã®å¼·åº¦ï¼ˆã‚³ã‚¹ãƒˆï¼‰ã§ã€é«˜ã„ã»ã©å®‰å…¨ã§ã™ãŒå‡¦ç†æ™‚é–“ã¯é•·ããªã‚Šã¾ã™
        const salt = await bcrypt.genSalt(10);
        const hashedPassword = await bcrypt.hash(password, salt);

        // 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¿å­˜
        const newUser = new User({
            username,
            password: hashedPassword // æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿å­˜
        });

        await newUser.save();

        // æˆåŠŸæ™‚ã®å¿œç­”
        res.status(201).send('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');

    } catch (err) {
        console.error(err);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
});

// ... (ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²APIã®ã‚³ãƒ¼ãƒ‰ã¯çœç•¥) ...

// JWTã‚’èª­ã¿è¾¼ã¿ã¾ã™
const jwt = require('jsonwebtoken');

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/login', async (req, res) => {
    try {
        const { username, password } = req.body;

        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã™
        const user = await User.findOne({ username });
        if (!user) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            return res.status(400).send('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
        }

        // 2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç…§åˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ vs DBã®æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰
        const isMatch = await bcrypt.compare(password, user.password);
        if (!isMatch) {
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            return res.status(400).send('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
        }

        // 3. ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ JWTï¼ˆãƒã‚±ãƒƒãƒˆï¼‰ã‚’ä½œæˆ
        const payload = {
            user: {
                id: user.id // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒã‚±ãƒƒãƒˆã«å«ã‚ã‚‹
            }
        };

        // ç§˜å¯†éµã‚’ä½¿ã£ã¦ãƒã‚±ãƒƒãƒˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’ç™ºè¡Œã—ã¾ã™
        jwt.sign(
            payload,
            process.env.JWT_SECRET, // .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç§˜å¯†éµã‚’å–å¾—
            { expiresIn: '1h' }, // ãƒã‚±ãƒƒãƒˆã®æœ‰åŠ¹æœŸé™ã¯1æ™‚é–“
            (err, token) => {
                if (err) throw err;
                // æˆåŠŸã—ãŸå¿œç­”ã¨ã—ã¦ã€ãƒã‚±ãƒƒãƒˆï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è¿”ã—ã¾ã™
                res.json({ token, message: 'ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼' });
            }
        );

    } catch (err) {
        console.error(err);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
});

ã€€// ... (ãƒ­ã‚°ã‚¤ãƒ³APIã®ã‚³ãƒ¼ãƒ‰ã¯çœç•¥) ...

// èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’èª­ã¿è¾¼ã¿ã¾ã™
const auth = require('./middleware/auth');

// ----------------------------------------------------
// ã‚¹ãƒ†ãƒƒãƒ— 7: æŠ•ç¨¿æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆæ¬¡ã«è¡Œã†ä½œæ¥­ï¼‰
// ----------------------------------------------------

// æŠ•ç¨¿ãƒ¢ãƒ‡ãƒ«ã‚‚èª­ã¿è¾¼ã¿ã¾ã™
const Post = require('./models/Post');

// æŠ•ç¨¿ä½œæˆAPI
// ã“ã“ã§ auth ã‚’ä½¿ã†ã“ã¨ã§ã€ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€ã‚ˆã†ã«ãªã‚Šã¾ã™
app.post('/api/posts', auth, async (req, res) => {
    // èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒé€šã‚Œã°ã€req.userã«ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ãŒå…¥ã£ã¦ã„ã¾ã™
    try {
        const newPost = new Post({
            content: req.body.content,
            author: req.user.id // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDã‚’æŠ•ç¨¿è€…ã¨ã—ã¦è¨˜éŒ²
        });

        const post = await newPost.save();
        res.json(post);
    } catch (err) {
        console.error(err.message);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼');
    }
});

// å…¨æŠ•ç¨¿ã‚’å–å¾—ã™ã‚‹ API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// ãƒ­ã‚°ã‚¤ãƒ³ã¯ä¸è¦ãªã®ã§ã€èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ (auth) ã¯ä½¿ã„ã¾ã›ã‚“ã€‚
app.get('/api/posts', async (req, res) => {
    try {
        // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’å–å¾—ã—ã¾ã™ã€‚
        // .find({}) ã§å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã—ã¾ã™ã€‚
        // .populate('author', 'username') ã§ã€æŠ•ç¨¿è€…ã®ID (author) ã‹ã‚‰ Userãƒ¢ãƒ‡ãƒ«ã‚’å‚ç…§ã—ã€
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å (username) ã ã‘ã‚’å–å¾—ã—ã¦æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã«å«ã‚ã¾ã™ã€‚
        // .sort({ createdAt: -1 }) ã§ã€æ–°ã—ã„æŠ•ç¨¿ãŒä¸€ç•ªä¸Šã«æ¥ã‚‹ã‚ˆã†ã«é™é †ã§ä¸¦ã¹æ›¿ãˆã¾ã™ã€‚
        const posts = await Post.find({})
            .populate('author', 'username') 
            .sort({ createdAt: -1 });
        
        // 2. å–å¾—ã—ãŸæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’ JSON å½¢å¼ã§ãƒ–ãƒ©ã‚¦ã‚¶ã«è¿”ã—ã¾ã™ã€‚
        res.json(posts);

    } catch (err) {
        console.error(err.message);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: æŠ•ç¨¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
});

// ... (æŠ•ç¨¿å–å¾— API ã®ã‚³ãƒ¼ãƒ‰ã¯çœç•¥) ...

// ã‚³ãƒ¡ãƒ³ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™
const Comment = require('./models/Comment');

// ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// POST /api/posts/:postId/comments ã®å½¢å¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™
app.post('/api/posts/:postId/comments', auth, async (req, res) => {
    try {
        const { content } = req.body;
        const postId = req.params.postId; // URLã‹ã‚‰æŠ•ç¨¿IDã‚’å–å¾—

        // æŠ•ç¨¿ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆä»»æ„ã ãŒæ¨å¥¨ï¼‰
        const post = await Post.findById(postId);
        if (!post) {
            return res.status(404).json({ msg: 'æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' });
        }

        // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        const newComment = new Comment({
            content,
            post: postId,         // ã©ã®æŠ•ç¨¿ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹
            author: req.user.id   // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
        });

        const comment = await newComment.save();
        
        // æˆåŠŸã—ãŸå¿œç­”ã¨ã—ã¦ã€ä½œæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿”ã—ã¾ã™
        res.json(comment);

    } catch (err) {
        console.error(err.message);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
});

// ã„ã„ã­ API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// PUT /api/posts/:postId/like ã®å½¢å¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™
app.put('/api/posts/:postId/like', auth, async (req, res) => {
    try {
        const postId = req.params.postId;

        // æŠ•ç¨¿ã‚’æ¢ã—ã€likesã®æ•°ã‚’1å¢—ã‚„ã™
        const post = await Post.findByIdAndUpdate(
            postId,
            { $inc: { likes: 1 } }, // $incã¯ã€Œã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆ1å¢—ã‚„ã™ï¼‰ã€ã¨ã„ã†æ„å‘³ã®MongoDBã®æ¼”ç®—å­ã§ã™
            { new: true }           // æ›´æ–°å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿”ã™ã‚ˆã†ã«æŒ‡å®š
        )
        .populate('author', 'username'); // æ›´æ–°å¾Œã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚ä¸€ç·’ã«å«ã‚ã‚‹

        if (!post) {
            return res.status(404).json({ msg: 'æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' });
        }

        // æˆåŠŸã—ãŸå¿œç­”ã¨ã—ã¦ã€ã„ã„ã­ãŒå¢—ãˆãŸæŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™
        res.json(post);

    } catch (err) {
        console.error(err.message);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã„ã„ã­å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
// GET /api/users/:username ã®å½¢å¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™
app.get('/api/users/:username', async (req, res) => {
    try {
        const profileUsername = req.params.username; // URLã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
        console.log(`[Profile API] ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã—ã¾ã—ãŸ: "${profileUsername}"`);
        
        // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        const user = await User.findOne({ username: profileUsername }).select('-password'); // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¿”ã•ãªã„
        if (!user) {
            return res.status(404).json({ msg: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' });
        }

        // 2. ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ç´ã¥ãæŠ•ç¨¿ã‚’å…¨ã¦å–å¾—
        const posts = await Post.find({ author: user._id })
            .populate('author', 'username') // æŠ•ç¨¿è€…åã‚‚ä¸€ç·’ã«å–å¾—
            .sort({ createdAt: -1 });

        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãã®æŠ•ç¨¿ä¸€è¦§ã‚’ JSON ã§è¿”ã—ã¾ã™
        res.json({
            user: {
                id: user._id,
                username: user.username,
                createdAt: user.createdAt
            },
            posts: posts
        });

    } catch (err) {
        console.error(err.message);
        res.status(500).send('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
});


